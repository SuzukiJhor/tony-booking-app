generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum StatusAgendamento {
  PENDENTE           // Rec√©m-criado, esperando o momento de envio da mensagem
  MENSAGEM_ENVIADA   // Mensagem enviada, aguardando resposta do paciente
  CONFIRMADO         // Paciente respondeu SIM
  NAO_CONFIRMADO     // Paciente respondeu N√ÉO ou prazo de resposta expirou
  CANCELADO          // Cancelado pelo usu√°rio (admin)
}

enum TipoAgendamento {
  CONSULTA
  RETORNO
  EXAME
}

// -----------------------------------------------------
// üè¢ Modelo Empresa (Tenant)
// -----------------------------------------------------
model Empresa {
  id               Int            @id @default(autoincrement())
  nome             String
  slug             String         @unique // URL amig√°vel, ex: 'clinica-alfa'
  planoAtivo       String         @default("FREE")
  
  // Relacionamentos Inversos (back-relations)
  pacientes        Paciente[]
  agendamentos     Agendamento[]
  configuracoes    Configuracao[] 
  acessos          AcessoSistema[]

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

// -----------------------------------------------------
// üë§ Modelo Paciente - Isolado por Empresa
// -----------------------------------------------------
model Paciente {
  id             Int             @id @default(autoincrement())
  nome           String
  telefone       String
  email          String?
  
  // Chave de Isolamento (Tenant ID)
  empresaId      Int
  empresa        Empresa         @relation(fields: [empresaId], references: [id])
  
  agendamentos   Agendamento[]

  // **IMPORTANTE:** O telefone deve ser √∫nico APENAS DENTRO DE UMA EMPRESA.
  @@unique([telefone, empresaId]) 
  // O campo 'email' original tinha @unique, se precisar manter a unicidade:
  @@unique([email, empresaId])
}

// -----------------------------------------------------
// üìÖ Modelo Agendamento - Isolado por Empresa
// -----------------------------------------------------
model Agendamento {
  id                Int                  @id @default(autoincrement())
  dataHora          DateTime
  statusConfirmacao StatusAgendamento    @default(PENDENTE)

  mensagemEnviadaEm DateTime?
  mensagemId        String?
  
  // Relacionamento com Paciente (que j√° pertence a uma empresa)
  pacienteId        Int
  paciente          Paciente             @relation(fields: [pacienteId], references: [id])
  
  // Chave de Isolamento (Tenant ID) - Recomendado para consultas mais r√°pidas
  empresaId         Int
  empresa           Empresa              @relation(fields: [empresaId], references: [id])

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  tipoAgendamento   TipoAgendamento      @default(CONSULTA)
  tempoAtendimento  Int                  @default(60)
   // Soft delete
  isDeleted         Boolean           @default(false)
}

// -----------------------------------------------------
// ‚öôÔ∏è Modelo Configura√ß√£o - Isolado por Empresa
// -----------------------------------------------------
model Configuracao {
  id      Int     @id @default(autoincrement())
  chave   String
  valor   String?

  // Chave de Isolamento (Tenant ID)
  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  // Garante que uma chave (ex: 'WHATSAPP_TOKEN') seja √∫nica POR EMPRESA
  @@unique([chave, empresaId]) 
}

model AcessoSistema {
  id            Int     @id @default(autoincrement())
  email         String  @unique 
  password      String  // hash da senha
  empresaId     Int?
  empresa       Empresa?   @relation(fields: [empresaId], references: [id])
  @@map("acesso_sistema")
}